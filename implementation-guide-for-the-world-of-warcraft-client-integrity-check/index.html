<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Implementation Guide for the World of Warcraft client integrity check | GTKer.com</title><style>body{font-family:Optima,Candara,Calibri,Arial,sans-serif}code{font-family:lucida console,Monaco,monospace;font-size:85%}</style><link rel=stylesheet href=https://gtker.com/sass/style.min.css><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest></head><body><nav><ul class=menu><li><a href=/>Home</a></li><li><a href=/about/>About</a></li><li><a href=/tags/>Tags</a></li><li><a href=/wow_messages/>wow_messages</a></li><li><a href=/index.xml>Atom/RSS</a></li></ul><hr></nav><div class=article-meta><h1><span class=title>Implementation Guide for the World of Warcraft client integrity check</span></h1><h2 class=date>2024-04-10</h2></div><p class=terms>Tags: <a href=/tags/rust>Rust</a> <a href=/tags/world-of-warcraft>World of Warcraft</a> <a href=/tags/wow>WoW</a> <a href=/tags/cryptography>Cryptography</a></p><nav id=TableOfContents><ul><li><a href=#generic>Generic</a><ul><li><a href=#implementations>Implementations</a></li><li><a href=#verification-values>Verification values</a></li></ul></li><li><a href=#windows>Windows</a><ul><li><a href=#verification-values-1>Verification values</a></li></ul></li><li><a href=#mac>Mac</a><ul><li><a href=#verification-values-2>Verification values</a></li></ul></li></ul><ul><li><ul><li><a href=#verification-values-3>Verification values</a></li><li><a href=#implementations-1>Implementations</a></li></ul></li></ul></nav><main><p>When an original World of Warcraft client (1.2 through to 3.3.5) authenticates with the server the client will send a hash of some local game files.
This post details how the client calculates the hash for World of Warcraft 1.12 and provides replication values in order to test your own implementation.</p><h1 id=background>Background</h1><p>The server sends a checksum salt in <a href=https://wowdev.wiki/CMD_AUTH_LOGON_CHALLENGE_Server><code>CMD_AUTH_LOGON_CHALLENGE_Server</code></a> in the field just after the SRP6 salt.
The client sends the final hash in <a href=https://wowdev.wiki/CMD_AUTH_LOGON_PROOF_Client><code>CMD_AUTH_LOGON_PROOF_Client</code></a> in the field just after the client proof.</p><p>The client does not require the server to make this calculation like it does for the SRP6 algorithm and malicious clients can just fake the proof, so there&rsquo;s no real security benefits to implementing this check.</p><p>The integrity check is different for login and reconnection.
The integrity check is not platform specific, but the specific files and contents of those files are platform and version specific.</p><p>This guide is specifically for 1.12, although it will probably work on other versions as well.</p><h1 id=implementation-details-for-login>Implementation details for login</h1><p>The implementation is a HMAC-SHA1 of game files together with the server provided checksum salt, and then a SHA1 of the resulting HMAC along with the client public key.
The implementation is not different for Mac/Windows, it only differs in the files that are checked.</p><h2 id=generic>Generic</h2><p>This describes a function that can be used for both Windows and Mac without any modifications.
The algorithm is the same as the platform specific versions, but all the checked files are just concatenated into a single slice to make the function generic.</p><ul><li><code>checksum_salt</code> is sent by the server in <a href=https://wowdev.wiki/CMD_AUTH_LOGON_CHALLENGE_Server><code>CMD_AUTH_LOGON_CHALLENGE_Server</code></a> in the field just after the SRP6 salt.</li><li><code>all_files</code> is all platform specific files concatenated together. See the platform specific versions for which specific files.</li><li><code>client_public_key</code> is the client public key provided by the client.</li><li><code>+</code> is array concatenation.</li></ul><p>Calculating the integrity hash in pseudo code would look like:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>function integrity_check_generic
</span></span><span style=display:flex><span>    argument all_files: array of an arbitrary amount of bytes
</span></span><span style=display:flex><span>    argument checksum_salt: array of 16 bytes
</span></span><span style=display:flex><span>    argument client_public_key: array of 32 bytes
</span></span><span style=display:flex><span>    returns array of 20 bytes
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    checksum_hmac = HmacSha1(checksum_salt)
</span></span><span style=display:flex><span>    checksum_hmac.update(all_files)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    checksum = checksum_hmac.finalize()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    return SHA1(client_public_key + checksum)
</span></span></code></pre></div><h3 id=implementations>Implementations</h3><ul><li><a href=https://github.com/gtker/wow_srp/blob/119468a4896b42f7e1bc2ecdfeb790592dd173ea/src/integrity.rs#L38>Rust (wow_srp)</a></li><li><a href=https://github.com/EmberEmu/Ember/blob/db3cede29360a68bb516b80e60215181d8c01e9e/src/login/ExecutablesChecksum.cpp#L15>C++ (Ember)</a></li></ul><h3 id=verification-values>Verification values</h3><ul><li><a href=verification_values/generic_regression.txt>generic_regression</a></li></ul><table><thead><tr><th><code>all_files</code></th><th><code>checksum_salt</code></th><th><code>client_public_key</code></th><th><code>expected</code></th></tr></thead><tbody><tr><td>Big endian Hex</td><td>Big Endian Hex</td><td>Big Endian Hex</td><td>Big Endian Hex</td></tr></tbody></table><h2 id=windows>Windows</h2><p>The windows integrity calculation uses the generic version, but it specifically enumerates the files required for Windows.</p><ul><li><code>wow_exe</code>, the bytes of the <code>WoW.exe</code> file.</li><li><code>fmod_dll</code>, the bytes of the <code>fmod.dll</code> file.</li><li><code>ijl15_dll</code>, the bytes of the <code>ijl15.dll</code> file.</li><li><code>dbghelp_dll</code>, the bytes of the <code>dbghelp.dll</code> file.</li><li><code>unicows_dll</code>, the bytes of the <code>unicows.dll</code> file.</li><li><code>checksum_salt</code> is sent by the server in <a href=https://wowdev.wiki/CMD_AUTH_LOGON_CHALLENGE_Server><code>CMD_AUTH_LOGON_CHALLENGE_Server</code></a> in the field just after the SRP6 salt.</li><li><code>client_public_key</code> is the client public key provided by the client.</li><li><code>+</code> is array concatenation.</li></ul><p>Calculating the integrity hash in pseudo code would look like:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>function integrity_check_windows
</span></span><span style=display:flex><span>    argument wow_exe: array of an arbitrary amount of bytes
</span></span><span style=display:flex><span>    argument fmod_dll: array of an arbitrary amount of bytes
</span></span><span style=display:flex><span>    argument ijl15_dll: array of an arbitrary amount of bytes
</span></span><span style=display:flex><span>    argument dbghelp_dll: array of an arbitrary amount of bytes
</span></span><span style=display:flex><span>    argument unicows_dll: array of an arbitrary amount of bytes
</span></span><span style=display:flex><span>    argument checksum_salt: array of 16 bytes
</span></span><span style=display:flex><span>    argument client_public_key: array of 32 bytes
</span></span><span style=display:flex><span>    returns array of 20 bytes
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    all_files = wow_exe + fmod_dll + ijl15_dll + dbghelp_dll + unicows_dll
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    return integrity_check_generic(all_files, checksum_salt, client_public_key)
</span></span></code></pre></div><h3 id=verification-values-1>Verification values</h3><ul><li><a href=verification_values/windows_regression.txt>windows_regression</a></li></ul><table><thead><tr><th><code>wow_exe</code></th><th><code>fmod_dll</code></th><th><code>ijl15_dll</code></th><th><code>dbghelp_dll</code></th><th><code>unicows_dll</code></th><th><code>checksum_salt</code></th><th><code>client_public_key</code></th><th><code>expected</code></th></tr></thead><tbody><tr><td>Big endian Hex</td><td>Big endian Hex</td><td>Big endian Hex</td><td>Big endian Hex</td><td>Big Endian Hex</td><td>Big Endian Hex</td><td>Big Endian Hex</td><td></td></tr></tbody></table><h2 id=mac>Mac</h2><p>The windows integrity calculation uses the generic version, but it specifically enumerates the files required for Windows.</p><ul><li><code>world_of_warcraft</code>, the bytes of the <code>MacOS/World of Warcraft</code> file.</li><li><code>info_plist</code>, the bytes of the <code>Info.plist</code> file.</li><li><code>objects_xib</code>, the bytes of the <code>Resources/Main.nib/objects.xib</code> file.</li><li><code>wow_icns</code>, the bytes of the <code>Resources/wow.icns</code> file.</li><li><code>pkg_info</code>, the bytes of the <code>PkgInfo</code> file.</li><li><code>checksum_salt</code> is sent by the server <a href=https://wowdev.wiki/CMD_AUTH_LOGON_CHALLENGE_Server><code>CMD_AUTH_LOGON_CHALLENGE_Server</code></a> in the field just after the SRP6 salt.</li><li><code>client_public_key</code> is the client public key provided by the client.</li><li><code>+</code> is array concatenation.</li></ul><p>Calculating the integrity hash in pseudo code would look like:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>function integrity_check_windows
</span></span><span style=display:flex><span>    argument world_of_warcraft: array of an arbitrary amount of bytes
</span></span><span style=display:flex><span>    argument info_plist: array of an arbitrary amount of bytes
</span></span><span style=display:flex><span>    argument objects_xib: array of an arbitrary amount of bytes
</span></span><span style=display:flex><span>    argument wow_icns: array of an arbitrary amount of bytes
</span></span><span style=display:flex><span>    argument pkg_info: array of an arbitrary amount of bytes
</span></span><span style=display:flex><span>    argument checksum_salt: array of 16 bytes
</span></span><span style=display:flex><span>    argument client_public_key: array of 32 bytes
</span></span><span style=display:flex><span>    returns array of 20 bytes
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    all_files = world_of_warcraft + info_plist + objects_xib + ow_icns + pkg_info
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    return integrity_check_generic(all_files, checksum_salt, client_public_key)
</span></span></code></pre></div><h3 id=verification-values-2>Verification values</h3><ul><li><a href=verification_values/mac_regression.txt>mac_regression</a></li></ul><table><thead><tr><th><code>world_of_warcraft</code></th><th><code>info_plist</code></th><th><code>objects_xib</code></th><th><code>wow_icns</code></th><th><code>pkg_info</code></th><th><code>checksum_salt</code></th><th><code>client_public_key</code></th><th><code>expected</code></th></tr></thead><tbody><tr><td>Big endian Hex</td><td>Big endian Hex</td><td>Big endian Hex</td><td>Big endian Hex</td><td>Big Endian Hex</td><td>Big Endian Hex</td><td>Big Endian Hex</td><td></td></tr></tbody></table><h1 id=implementation-details-for-reconnect>Implementation details for reconnect</h1><p>The reconnection integrity check does away with any local files and simply gets the SHA1 of the provided salt along with a zero buffer.
This is likely to save on resources since it would be very unlikely for the files to change in between login and reconnecting.</p><ul><li><code>checksum_salt</code> is sent by the server <a href=https://wowdev.wiki/CMD_AUTH_RECONNECT_CHALLENGE_Server><code>CMD_AUTH_RECONNECT_CHALLENGE_Server</code></a> in the field just after the SRP6 salt.</li><li><code>+</code> is array concatenation.</li></ul><p>Calculating the reconnect integrity hash in pseudo code would look like:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>function integrity_check_reconnect
</span></span><span style=display:flex><span>    argument checksum_salt: array of an arbitrary amount of bytes
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    # Array of 16 bytes, filled with zero
</span></span><span style=display:flex><span>    all_zero = [0; 16]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    return SHA1(checksum_salt + all_zero)
</span></span></code></pre></div><h3 id=verification-values-3>Verification values</h3><ul><li><a href=verification_values/reconnect_regression.txt>reconnect_regression</a></li></ul><table><thead><tr><th><code>checksum_salt</code></th><th><code>expected</code></th></tr></thead><tbody><tr><td>Big endian Hex</td><td>Big endian Hex</td></tr></tbody></table><h3 id=implementations-1>Implementations</h3><ul><li><a href=https://github.com/gtker/wow_srp/blob/119468a4896b42f7e1bc2ecdfeb790592dd173ea/src/integrity.rs#L120>Rust (wow_srp)</a></li><li><a href=https://github.com/EmberEmu/Ember/blob/03c130d3d6276e7032fc9e13c9d287ea7c6ed536/src/login/LoginHandler.cpp#L370>C++ (Ember)</a></li></ul></main><footer><hr>© GTKer.com 2024 | <a href=mailto:contact@gtker.com>Contact</a></footer></body></html>