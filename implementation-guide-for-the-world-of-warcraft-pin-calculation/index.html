<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Implementation Guide for the World of Warcraft PIN calculation | GTKer.com</title><style>body{font-family:Optima,Candara,Calibri,Arial,sans-serif}code{font-family:lucida console,Monaco,monospace;font-size:85%}</style><link rel=stylesheet href=https://gtker.com/sass/style.min.css><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest></head><body><nav><ul class=menu><li><a href=/>Home</a></li><li><a href=/about/>About</a></li><li><a href=/tags/>Tags</a></li><li><a href=/wow_messages/>wow_messages</a></li><li><a href=/index.xml>Atom/RSS</a></li></ul><hr></nav><div class=article-meta><h1><span class=title>Implementation Guide for the World of Warcraft PIN calculation</span></h1><h2 class=date>2024-04-29</h2></div><p class=terms>Tags: <a href=/tags/rust>Rust</a> <a href=/tags/world-of-warcraft>World of Warcraft</a> <a href=/tags/wow>WoW</a> <a href=/tags/cryptography>Cryptography</a></p><nav id=TableOfContents><ul><li><a href=#main-algorithm>Main Algorithm</a><ul><li><a href=#implementations>Implementations</a></li><li><a href=#verification-values>Verification values</a></li></ul></li><li><a href=#remap-pin-grid>Remap PIN Grid</a><ul><li><a href=#implementations-1>Implementations</a></li><li><a href=#verification-values-1>Verification values</a></li></ul></li><li><a href=#randomize-grid>Randomize Grid</a><ul><li><a href=#implementations-2>Implementations</a></li><li><a href=#verification-values-2>Verification values</a></li></ul></li></ul></nav><main><p>Starting with client version 1.12 the user can enter a PIN which is hashed and sent to the server.
This post details how the client calculates the hash for World of Warcraft 1.12 and provides replication values in order to test your own implementation.</p><h1 id=background>Background</h1><p>The server may send a PIN grid seed and PIN salt in <a href=https://gtker.com/wow_messages/docs/cmd_auth_logon_challenge_server.html><code>CMD_AUTH_LOGON_CHALLENGE_Server</code></a>
<span><sup><a href=https://wowdev.wiki/CMD_AUTH_LOGON_CHALLENGE_Server>wiki</a></sup></span>
if it chooses.
The client may send the PIN salt and client PIN hash in <a href=https://gtker.com/wow_messages/docs/cmd_auth_logon_proof_client.html><code>CMD_AUTH_LOGON_PROOF_Client</code></a>
<span><sup><a href=https://wowdev.wiki/CMD_AUTH_LOGON_PROOF_Client>wiki</a></sup></span>
in the field just after the client proof.</p><p>Figure 1 shows the PIN window during login.</p><figure><img src=pin.png alt="The PIN window shown during login after entering password."></img><figcaption><b>Figure 1:</b> The PIN window shown during login after entering password.<br></figure><p>The client does not require the server to prove that expected key matches like it does for the primary authentication check.</p><p>This will work for all versions after 1.12.</p><p>The PIN the client enters can either be a static (it never changes) or be <a href=https://en.wikipedia.org/wiki/Time-based_one-time_password>time based</a>, the client just sends the digits entered by the user.</p><p>PINs can be between 4 and 10 digits long.</p><p>The implementation is the same for the server and client.
They will both calculate a hash for the entered digits and the server will then compare the two hashes for equality.</p><p>The grid of the PIN can be randomized with the PIN grid seed sent by the server.
This will move the locations of the numbers so that they are no longer in order.
So instead of the keypad being <code>1, 2, 3, ...</code>, it could be <code>9, 2, 5, ...</code>.
Figure 2 shows the randomized PIN window.</p><figure><img src=randomized-pin.png alt="The randomized PIN window."></img><figcaption><b>Figure 2:</b> The randomized PIN window.<br></figure><h1 id=implementation-details>Implementation details</h1><p><a href=#main-algorithm>The algorithm</a> goes through the following steps:</p><ul><li>Get the PIN from the client or database.</li><li><a href=#remap-pin-grid>Use the PIN grid seed to randomize the grid.</a></li><li><a href=#randomize-grid>Apply the randomized grid to the PIN.</a></li><li>Convert PIN to ASCII by adding <code>0x30</code> (48) to every value.</li><li>The PIN is SHA1 hashed twice along with server and client salts.</li></ul><p>The PIN is in the form of a byte array of at least 4 bytes and at most 10 bytes, where every byte is a single digit of the PIN.
So a PIN of <code>1, 2, 3, 4</code> would be an array of <code>[1, 2, 3, 4]</code>.</p><h2 id=main-algorithm>Main Algorithm</h2><p>This function ties everything together.</p><ul><li><code>pin</code> is the digits of the PIN code as a byte array.</li><li><code>pin_grid_seed</code> is the PIN grid seed.</li><li><code>server_salt</code> is the salt sent by the server.</li><li><code>client_salt</code> is the salt sent by the client.</li><li><code>%</code> is the modulus operator.</li><li><code>+</code> is array concatenation.</li><li><code>SHA1</code> is the SHA1 hash function.</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>function calculate_hash
</span></span><span style=display:flex><span>    argument pin: array of bytes
</span></span><span style=display:flex><span>    argument pin_grid_seed: u32
</span></span><span style=display:flex><span>    argument server_salt: array of 16 bytes
</span></span><span style=display:flex><span>    argument client_salt: array of 16 bytes
</span></span><span style=display:flex><span>    returns array of 20 bytes
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    remapped_pin_grid = remap_pin_grid(pin_grid_seed)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    randomized_grid = randomize_grid(pin, remapped_pin_grid)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    # Convert to ASCII
</span></span><span style=display:flex><span>    for b in randomized_grid:
</span></span><span style=display:flex><span>        b += 0x30
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    first_hash = SHA1(server_salt + randomized_grid)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    return SHA1(client_salt + first_hash)
</span></span></code></pre></div><h3 id=implementations>Implementations</h3><ul><li><a href=https://github.com/gtker/wow_srp/blob/6f9501c55dec35fe1ca5c2b4f2b19561d8b43244/src/pin.rs#L136>Rust (wow_srp)</a></li><li><a href=https://github.com/EmberEmu/Ember/blob/953e6dcd8e006c49c56fd8b54c95cf00aba71f06/src/login/PINAuthenticator.cpp#L118>C++ (Ember)</a></li></ul><h3 id=verification-values>Verification values</h3><ul><li><a href=verification_values/regression.txt>regression</a></li></ul><table><thead><tr><th><code>pin</code></th><th><code>pin_grid_seed</code></th><th><code>server_salt</code></th><th><code>client_salt</code></th><th><code>expected</code></th></tr></thead><tbody><tr><td>Unsigned integer</td><td>Unsigned integer</td><td>Big Endian Hex</td><td>Big Endian Hex</td><td>Big Endian Hex</td></tr></tbody></table><h2 id=remap-pin-grid>Remap PIN Grid</h2><p>This function converts the PIN grid seed into a remapped array.</p><ul><li><code>pin_grid_seed</code> is sent by the server in <a href=https://wowdev.wiki/CMD_AUTH_LOGON_CHALLENGE_Server><code>CMD_AUTH_LOGON_CHALLENGE_Server</code></a>.</li><li><code>%</code> is the modulus operator.</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>function remap_pin_grid
</span></span><span style=display:flex><span>    argument pin_grid_seed: u32
</span></span><span style=display:flex><span>    returns array of 10 bytes
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    grid = [0, 1, 2, 3, 4, 5, 6, 7, 8, 9]
</span></span><span style=display:flex><span>    remapped_grid = [0, 1, 2, 3, 4, 5, 6, 7, 8, 9]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    # Go backwards
</span></span><span style=display:flex><span>    for i in 10..0:
</span></span><span style=display:flex><span>        remainder = pin_grid_seed % i
</span></span><span style=display:flex><span>        pin_grid_seed = pin_grid_seed / i
</span></span><span style=display:flex><span>        remapped_grid[i] = grid[i]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        copy_size = i - remainder - 1
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        for j in 0..copy_size:
</span></span><span style=display:flex><span>            grid[remainder + j] = grid[remainder + i + 1]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    return remapped_grid
</span></span></code></pre></div><h3 id=implementations-1>Implementations</h3><ul><li><a href=https://github.com/gtker/wow_srp/blob/6f9501c55dec35fe1ca5c2b4f2b19561d8b43244/src/pin.rs#L180>Rust (wow_srp)</a></li><li><a href=https://github.com/EmberEmu/Ember/blob/953e6dcd8e006c49c56fd8b54c95cf00aba71f06/src/login/PINAuthenticator.cpp#L67>C++ (Ember)</a></li></ul><h3 id=verification-values-1>Verification values</h3><ul><li><a href=verification_values/remap_regression.txt>remap_regression</a></li></ul><table><thead><tr><th><code>pin_grid_seed</code></th><th><code>expected</code></th></tr></thead><tbody><tr><td>Unsigned integer</td><td>Big Endian Hex</td></tr></tbody></table><h2 id=randomize-grid>Randomize Grid</h2><p>This function converts the PIN grid seed into a remapped array.</p><ul><li><code>pin_grid_seed</code> is sent by the server in <a href=https://wowdev.wiki/CMD_AUTH_LOGON_CHALLENGE_Server><code>CMD_AUTH_LOGON_CHALLENGE_Server</code></a>.</li><li><code>%</code> is the modulus operator.</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>function randomize_grid
</span></span><span style=display:flex><span>    argument bytes: array of bytes
</span></span><span style=display:flex><span>    argument remapped_pin_grid: array of 10 bytes
</span></span><span style=display:flex><span>    returns array of bytes
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    randomized_grid = array of 10 bytes
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    for i, byte in enumerate(bytes):
</span></span><span style=display:flex><span>        remapped_value = index of byte value from remapped_pin_grid
</span></span><span style=display:flex><span>        randomized_grid[i] = remapped_value
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    return randomized_grid
</span></span></code></pre></div><h3 id=implementations-2>Implementations</h3><ul><li><a href=https://github.com/gtker/wow_srp/blob/6f9501c55dec35fe1ca5c2b4f2b19561d8b43244/src/pin.rs#L199>Rust (wow_srp)</a></li><li><a href=https://github.com/EmberEmu/Ember/blob/953e6dcd8e006c49c56fd8b54c95cf00aba71f06/src/login/PINAuthenticator.cpp#L97-L98>C++ (Ember)</a></li></ul><h3 id=verification-values-2>Verification values</h3><ul><li><a href=verification_values/convert_regression.txt>convert_regression</a></li></ul><table><thead><tr><th><code>bytes</code></th><th><code>remapped_pin_grid</code></th><th><code>expected</code></th></tr></thead><tbody><tr><td>Big Endian Hex</td><td>Big Endian Hex</td><td>Big Endian Hex</td></tr></tbody></table></main><footer><hr>Â© GTKer.com 2024 | <a href=mailto:contact@gtker.com>Contact</a></footer></body></html>