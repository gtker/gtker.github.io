<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Regulating Unwanted Smart Device Traffic Using PiHole and Edgerouter X | GTKer.com</title><style>body{font-family:Optima,Candara,Calibri,Arial,sans-serif}code{font-family:lucida console,Monaco,monospace;font-size:85%}</style><link rel=stylesheet href=https://gtker.com/sass/style.min.css><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest></head><body><nav><ul class=menu><li><a href=/>Home</a></li><li><a href=/about/>About</a></li><li><a href=/tags/>Tags</a></li><li><a href=/wow_messages/>wow_messages</a></li><li><a href=/index.xml>Atom/RSS</a></li></ul><hr></nav><div class=article-meta><h1><span class=title>Regulating Unwanted Smart Device Traffic Using PiHole and Edgerouter X</span></h1><h2 class=date>2020-12-06</h2></div><p class=terms>Tags: <a href=/tags/pihole>PiHole</a> <a href=/tags/edgerouter-x>Edgerouter X</a> <a href=/tags/dns>DNS</a> <a href=/tags/blocking>Blocking</a></p><nav id=TableOfContents><ul><li><a href=#prerequisites>Prerequisites</a></li><li><a href=#dns-blocking-on-pihole>DNS blocking on Pihole</a></li><li><a href=#dns-redirection-on-edgerouter-x>DNS Redirection on Edgerouter X</a></li><li><a href=#testing>Testing</a></li></ul></nav><main><p>98% of smart assistants and 72% of smart TVs use hard coded DNS servers. <sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>
The inclusion of ads on smart TVs even by well known brands like <a href=https://www.rtings.com/tv/tests/ads-in-smart-tv>Samsung, Sony and LG</a> (<a href=https://web.archive.org/web/20201112014902/https://www.rtings.com/tv/tests/ads-in-smart-tv>archive</a>) significantly increases the need for forced DNS adblocking of devices that deliberately ignore DHCP provided DNS.
A Pihole DNS by itself can prevent ads from devices that are well behaved, but misbehaving devices will have to be forced by either a firewall or router.</p><h2 id=prerequisites>Prerequisites</h2><p>It is assumed that a working Pihole newer than version 5 is set up at <code>192.168.1.11</code> with an accessible admin interface at <code>http://192.168.1.11</code> and that a working Edgerouter X is set up at <code>192.168.1.1</code> with an accessible admin interface at <code>https://192.168.1.1</code>.
It might be necessary to downgrade the Edgerouter X connection to HTTP depending on settings.</p><p>The device to be regulated is assumed to be located at <code>192.168.1.60</code>, and it will be referred to as &ldquo;the TV&rdquo; from now on.
It is assumed that the TV has a reason for being on the network, since the most effective way of preventing something from communicating through a network is by not connecting it to the network.
The tutorial below assumes that a single service must be used through a smart TV, and that everything else must be blocked.</p><p>Be aware that <code>192.168.**1**.0</code> and <code>192.168.**0**.0</code> are two popular address spaces for home networks that look alike at a glance.
Make sure that you&rsquo;re using the correct network for you, despite what the examples say.</p><h2 id=dns-blocking-on-pihole>DNS blocking on Pihole</h2><p>The images are from version 5.1.1 of the Pihole Web Interface.</p><p>Log in to the Pihole Web Interface at <code>http://192.168.1.11/admin</code>.</p><p>Go to &ldquo;Groups&rdquo; under &ldquo;Group Management&rdquo; in the left menu as seen in figure 1.<figure><img src=pihole/navigation-menu.png alt="Navigation Menu on the left side of the Pihole Web Interface."></img><figcaption><b>Figure 1:</b> Navigation Menu on the left side of the Pihole Web Interface.<br></figure></p><p>Add a new group called &ldquo;TV&rdquo; and put any comments in the &ldquo;Description&rdquo; field as seen in figure 2.</p><figure><img src=pihole/new-group.png alt="Adding a new group named 'TV'. Only 'Name' is relevant, 'Description' is only documentation."></img><figcaption><b>Figure 2:</b> Adding a new group named 'TV'. Only 'Name' is relevant, 'Description' is only documentation.<br></figure><p>Go to &ldquo;Clients&rdquo; through the same menu as figure 1.</p><p>Add the address of the TV as seen in figure 3 and include a short description.
It is recommended to identify the address in some way, even if it&rsquo;s just &ldquo;TV&rdquo;, since few people can correctly remember the IP-addresses of every device on their LAN.
If the address of the TV is not found in the dropdown you can manually insert it using the &ldquo;Custom, specified below&rdquo; option.</p><figure><img src=pihole/add-new-client.png alt="Adding a new client by using the 'Custom, specified below...' option and manually inputting the address."></img><figcaption><b>Figure 3:</b> Adding a new client by using the 'Custom, specified below...' option and manually inputting the address.<br></figure><p>Assign the new client to the group made in figure 2 and remove it from the &ldquo;Default&rdquo; group as seen in figure 4.</p><figure><img src=pihole/client-to-group.png alt="Adding a new client to the 'TV' group and removing it from the 'Default' group."></img><figcaption><b>Figure 4:</b> Adding a new client to the 'TV' group and removing it from the 'Default' group.<br></figure><p>Next, go to &ldquo;Domains&rdquo; through the same menu as figure 1.</p><p>Add <code>[a-z]*|[0-9]*|\.</code> as a &ldquo;Domain&rdquo;, and <code>Block all domains.</code> as the &ldquo;Comment&rdquo; as seen in figure 5, and click &ldquo;Add to Blacklist&rdquo; just below.
Remember to check the &ldquo;Add domain as wildcard.
This will block all domains.</p><figure><img src=pihole/block-all-domains.png alt="Adding the regular expression '[a-z]*|[0-9]*|\.' to 'Domain' in order to block all domains. Make sure to check 'Add domain as wildcard'. The 'Add to Blacklist' button is found just below this."></img><figcaption><b>Figure 5:</b> Adding the regular expression '[a-z]*|[0-9]*|\.' to 'Domain' in order to block all domains. Make sure to check 'Add domain as wildcard'. The 'Add to Blacklist' button is found just below this.<br></figure><p>Scroll down until you find the filter you added in figure 5.</p><p>Ensure that the <code>[a-z]*|[0-9]*|\.</code> filter you just added is a &ldquo;Regex blacklist&rdquo;, &ldquo;Enabled&rdquo; and applied only to the group you created in figure 2.
It <strong>must</strong> not be applied to the &ldquo;Default&rdquo; group, otherwise all domains will be blocked on all devices.</p><figure><img src=pihole/apply-all-to-tv.png alt="List of blocklists on the Pihole. Ensure that the recently added filter is listed as 'Regex  blacklist', 'Enabled' and in the 'TV' group but not in the 'Default' group."></img><figcaption><b>Figure 6:</b> List of blocklists on the Pihole. Ensure that the recently added filter is listed as 'Regex blacklist', 'Enabled' and in the 'TV' group but not in the 'Default' group.<br></figure><p>All DNS queries are now blocked on the TV, and you must manually approve individual services that you require.
To find out whether you need to set up your Edgerouter X for DNS redirection you should turn on your TV and check if network features are completely broken.
If they are, your TV respects the DHCP provided DNS, and if they are not you either have not set your Pihole as the DNS in your DHCP settings or your TV does not respect DHCP settings.</p><p>You will now need to approve the necessary domains for your service to work.
After trying to access the required service on your TV, go into the &ldquo;Query Log&rdquo; under &ldquo;Long-term data&rdquo; in the left menu.
Select the date and time range &ldquo;Today&rdquo;.
Scroll down and narrow the search to your TV by entering <code>192.168.1.60</code> in the &ldquo;Search&rdquo; field like in figure 7.
The exact domain depends on the service you&rsquo;re trying to allow.
If you&rsquo;re in doubt, do a search for the domain in question and read up on what it does.
It might be necessary to do this over several iterations, as services on the TV might require different domains at several points.</p><figure><img src=pihole/approve-domains.png alt="Approving domains for the TV. The search has been used to narrow the list to only the TV. Domains can be allowed with the 'Whitelist' button on the right. A records are IPv4 and AAAA records are IPv6."></img><figcaption><b>Figure 7:</b> Approving domains for the TV. The search has been used to narrow the list to only the TV. Domains can be allowed with the 'Whitelist' button on the right. A records are IPv4 and AAAA records are IPv6.<br></figure><h2 id=dns-redirection-on-edgerouter-x>DNS Redirection on Edgerouter X</h2><p>If your TV does not use the DHCP DNS by default, you should set up DNS redirection on a firewall or router.</p><p>Log into the web interface of your Edgerouter X and click the &ldquo;Firewall/NAT&rdquo; tab as shown in figure 8.</p><figure><img src=edgerouterx/firewall.png alt="Firewall/NAT tab on the Edgerouter X."></img><figcaption><b>Figure 8:</b> Firewall/NAT tab on the Edgerouter X.<br></figure><p>Next, click the &ldquo;NAT&rdquo; tab as shown in figure 9.</p><figure><img src=edgerouterx/nat.png alt="NAT tab in the Firewall/NAT tab."></img><figcaption><b>Figure 9:</b> NAT tab in the Firewall/NAT tab.<br></figure><p>Click the &ldquo;Add Source NAT Rule&rdquo; button as shown in figure 10.</p><figure><img src=edgerouterx/add-source-nat.png alt="Adding new source rule."></img><figcaption><b>Figure 10:</b> Adding new source rule.<br></figure><p>Set up the rule as shown in figure 11, paying special attention to the below fields:</p><ol><li><strong>Description:</strong> Name of the rule.</li><li><strong>Outbound Interface:</strong> If you used the Basic Wizard to set up the Edgerouter X, you should set this to <code>switch0</code>.</li><li><strong>Src Address:</strong> The addresses that this rule should apply to. Since my DHCP range is <code>192.168.1.100</code> to <code>192.168.1.254</code> that&rsquo;s what I&rsquo;m putting in. If you only want to apply to the TV, set it to <code>192.168.1.1.60</code>.</li><li><strong>Src Port:</strong> Leave blank.</li><li><strong>Dest Address:</strong> Set to the address of your Pihole. Set to <code>192.168.1.11</code>.</li><li><strong>Dest Port:</strong> Set to <code>53</code>.</li></ol><figure><img src=edgerouterx/source-nat-settings.png alt="Screen for creating new source NAT rules."></img><figcaption><b>Figure 11:</b> Screen for creating new source NAT rules.<br></figure><p>Click save on figure 11 and then &ldquo;Add Destination NAT Rule&rdquo; just below the button in figure 10.</p><p>Set up the rule as shown in figure 12, paying special attention to the below fields:</p><ol><li><strong>Description:</strong> Name of the rule.</li><li><strong>Inbound Interface:</strong> Same as in figure 11.</li><li><strong>Translations Address:</strong> Set to the address of your Pihole, <code>192.168.1.11</code>.</li><li><strong>Translations Port:</strong> Set to <code>53</code>.</li><li><strong>Src Address:</strong> Set to addresses you want to redirect DNS for. For everything except your pihole set to <code>!192.168.1.11</code>, noticing the <code>!</code> which means <code>NOT</code>.</li><li><strong>Src Port:</strong> Leave blank.</li><li><strong>Dest Address:</strong> Set to the same as Src Address.</li><li><strong>Dest Port:</strong> Set to 53.</li></ol><figure><img src=edgerouterx/destination-nat-settings.png alt="Screen for creating new source NAT rules."></img><figcaption><b>Figure 12:</b> Screen for creating new source NAT rules.<br></figure><h2 id=testing>Testing</h2><p>In order to test your solution you should, on Windows or Linux, run <code>nslookup [blocked domain] 8.8.8.8</code> and see that you get a <code>0.0.0.0</code> result back.</p><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p>M. H. Mazhar and Z. Shafiq, &ldquo;<a href=https://arxiv.org/pdf/2001.08288.pdf>Characterizing Smart Home IoT Traffic in the Wild</a>&rdquo;, 2020 IEEE/ACM Fifth International Conference on Internet-of-Things Design and Implementation (IoTDI), pp. 2, Mar. 2020.&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></main><footer><hr>© GTKer.com 2024 | <a href=mailto:contact@gtker.com>Contact</a></footer></body></html>